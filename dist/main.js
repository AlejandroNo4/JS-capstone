(()=>{"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=h(e);if(t){var s=h(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return o(this,n)}}function o(t,n){return!n||"object"!==e(n)&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t):n}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var c=function(e){s(r,Phaser.Scene);var n=a(r);function r(){return t(this,r),n.call(this,"Start")}return i(r,[{key:"preload",value:function(){this.load.image("map-atlas","./assets/map/mapTiles.png"),this.load.tilemapTiledJSON("map","./assets/map/map.json"),this.load.spritesheet("player","./assets/images/characters/player.png",{frameHeight:138.8,frameWidth:109.5}),this.load.image("blue-plant","./assets/images/characters/enemy-plant-blue.png"),this.load.image("orange-plant","./assets/images/characters/enemy-plant-orange.png")}},{key:"create",value:function(){this.scene.start("GamePlay")}}]),r}(),l=function(e){s(r,Phaser.Scene);var n=a(r);function r(){return t(this,r),n.call(this,"GamePlay")}return i(r,[{key:"preload",value:function(){}},{key:"onMeetEnemy",value:function(e,t){t.x=Phaser.Math.RND.between(0,this.physics.world.bounds.width),t.y=Phaser.Math.RND.between(0,this.physics.world.bounds.height),this.cameras.main.shake(300),this.scene.switch("BattleScene")}},{key:"wake",value:function(){this.cursors.left.reset(),this.cursors.right.reset(),this.cursors.up.reset(),this.cursors.down.reset()}},{key:"create",value:function(){var e=this.make.tilemap({key:"map"}),t=e.addTilesetImage("map-tileset","map-atlas"),n=(e.createLayer("Terrain",t,0,0),e.createLayer("Obstacles",t,0,0));n.setCollisionByExclusion([-1]),e.createLayer("Details",t,0,0),this.player=this.physics.add.sprite(400,12750,"player",64),this.physics.world.bounds.width=e.widthInPixels,this.physics.world.bounds.height=e.heightInPixels,this.player.setCollideWorldBounds(!0),this.cursors=this.input.keyboard.createCursorKeys(),this.anims.create({key:"up",frames:this.anims.generateFrameNumbers("player",{frames:[64,65,66,67,68,69,70,71]}),frameRate:10}),this.anims.create({key:"down",frames:this.anims.generateFrameNumbers("player",{frames:[0,1,2,3,4,5,6,7]}),frameRate:10}),this.anims.create({key:"left",frames:this.anims.generateFrameNumbers("player",{frames:[32,33,34,35,36,37,38,39]}),frameRate:10}),this.anims.create({key:"right",frames:this.anims.generateFrameNumbers("player",{frames:[24,25,26,27,28,29,30,31]}),frameRate:10}),this.anims.create({key:"downLeft",frames:this.anims.generateFrameNumbers("player",{frames:[16,17,18,19,20,21,22,23]}),frameRate:10}),this.anims.create({key:"upLeft",frames:this.anims.generateFrameNumbers("player",{frames:[48,49,50,51,52,53,54,55]}),frameRate:10}),this.anims.create({key:"downRight",frames:this.anims.generateFrameNumbers("player",{frames:[8,9,10,11,12,13,14,15]}),frameRate:10}),this.anims.create({key:"upRight",frames:this.anims.generateFrameNumbers("player",{frames:[40,41,42,43,44,45,46,47]}),frameRate:10}),this.cameras.main.setBounds(0,0,e.widthInPixels,e.heightInPixels),this.cameras.main.startFollow(this.player),this.player.setCollideWorldBounds(!0),this.physics.add.collider(this.player,n),this.enemies=this.physics.add.group({classType:Phaser.GameObjects.Zone});for(var i=0;i<10;i++){var s=Phaser.Math.RND.between(0,this.physics.world.bounds.width),r=Phaser.Math.RND.between(0,this.physics.world.bounds.height);this.enemies.create(s,r,20,20)}this.physics.add.overlap(this.player,this.enemies,this.onMeetEnemy,!1,this),this.sys.events.on("wake",this.wake,this)}},{key:"update",value:function(){this.player.body.setVelocity(0),this.player.body.allowGravity=!1,this.moved=!1,this.cursors.left.isDown&&(this.moved=!0,this.player.body.setVelocityX(-150)),this.cursors.right.isDown&&(this.moved=!0,this.player.body.setVelocityX(150)),this.cursors.up.isDown&&(this.moved=!0,this.player.body.setVelocityY(-150)),this.cursors.down.isDown&&(this.moved=!0,this.player.body.setVelocityY(150)),this.moved||this.player.anims.stop(),0==this.player.body.velocity.y&&(this.player.body.velocity.x<0?this.player.anims.play("left",!0):this.player.body.velocity.x>0&&this.player.anims.playReverse("right",!0)),0==this.player.body.velocity.x&&(this.player.body.velocity.y<0?this.player.anims.play("up",!0):this.player.body.velocity.y>0&&this.player.anims.play("down",!0)),0!==this.player.body.velocity.x&&0!==this.player.body.velocity.y&&(this.player.body.velocity.x<0&&this.player.body.velocity.y<0?this.player.anims.play("upLeft",!0):this.player.body.velocity.x>0&&this.player.body.velocity.y>0?this.player.anims.playReverse("downRight",!0):this.player.body.velocity.x>0&&this.player.body.velocity.y<0?this.player.anims.playReverse("upRight",!0):this.player.body.velocity.x<0&&this.player.body.velocity.y>0&&this.player.anims.play("downLeft",!0))}}]),r}();function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t&&y(e.prototype,t),n&&y(e,n),e}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=I(e);if(t){var s=I(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return b(this,n)}}function b(e,t){return!t||"object"!==u(t)&&"function"!=typeof t?g(e):t}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function I(e){return(I=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var k=function(e){d(n,Phaser.Scene);var t=v(n);function n(){return m(this,n),t.call(this,"BattleScene")}return f(n,[{key:"preload",value:function(){}},{key:"receivePlayerSelection",value:function(e,t){"attack"==e&&this.units[this.index].attack(this.enemies[t]),this.time.addEvent({delay:3e3,callback:this.nextTurn,callbackScope:this})}},{key:"exitBattle",value:function(){this.scene.sleep("UIScene"),this.scene.switch("GamePlay")}},{key:"wake",value:function(){this.scene.run("UIScene"),this.time.addEvent({delay:2e3,callback:this.exitBattle,callbackScope:this})}},{key:"startBattle",value:function(){this.cameras.main.setBackgroundColor("rgba(0, 200, 0, 0.5)");var e=new M(this,600,130,"player",1,"Warrior",100,20);this.add.existing(e);var t=new M(this,600,300,"player",25,"Mage",80,8);this.add.existing(t);var n=new S(this,150,130,"blue-plant",null,"Plant",50,3);this.add.existing(n);var i=new S(this,150,300,"orange-plant",null,"Plant2",50,3);this.add.existing(i),this.heroes=[e,t],this.enemies=[n,i],this.units=this.heroes.concat(this.enemies),this.index=-1,this.scene.run("UIScene")}},{key:"create",value:function(){this.cameras.main.setBackgroundColor("rgba(0, 200, 0, 0.5)"),this.startBattle(),this.sys.events.on("wake",this.startBattle,this)}},{key:"checkEndBattle",value:function(){for(var e=!0,t=0;t<this.enemies.length;t++)this.enemies[t].living&&(e=!1);var n=!0;for(t=0;t<this.heroes.length;t++)this.heroes[t].living&&(n=!1);return e||n}},{key:"endBattle",value:function(){this.heroes.length=0,this.enemies.length=0;for(var e=0;e<this.units.length;e++)this.units[e].destroy();this.units.length=0,this.scene.sleep("UIScene"),this.scene.switch("WorldScene")}},{key:"nextTurn",value:function(){if(this.checkEndBattle())this.endBattle();else{do{this.index++,this.index>=this.units.length&&(this.index=0)}while(!this.units[this.index].living);if(this.units[this.index]instanceof M)this.events.emit("PlayerSelect",this.index);else{var e;do{e=Math.floor(Math.random()*this.heroes.length)}while(!this.heroes[e].living);this.units[this.index].attack(this.heroes[e]),this.time.addEvent({delay:3e3,callback:this.nextTurn,callbackScope:this})}}}}]),n}(),w=function(e){d(n,Phaser.Scene);var t=v(n);function n(){return m(this,n),t.call(this,"UIScene")}return f(n,[{key:"preload",value:function(){}},{key:"remapHeroes",value:function(){var e=this.battleScene.heroes;this.heroesMenu.remap(e)}},{key:"remapEnemies",value:function(){var e=this.battleScene.enemies;this.enemiesMenu.remap(e)}},{key:"onKeyInput",value:function(e){this.currentMenu&&this.currentMenu.selected&&("ArrowUp"===e.code?this.currentMenu.moveSelectionUp():"ArrowDown"===e.code?this.currentMenu.moveSelectionDown():"ArrowRight"===e.code||"Shift"===e.code||"Space"!==e.code&&"ArrowLeft"!==e.code||this.currentMenu.confirm())}},{key:"onPlayerSelect",value:function(e){this.heroesMenu.select(e),this.actionsMenu.select(0),this.currentMenu=this.actionsMenu}},{key:"onSelectAction",value:function(){this.currentMenu=this.enemiesMenu,this.enemiesMenu.select(0)}},{key:"onEnemy",value:function(e){this.heroesMenu.deselect(),this.actionsMenu.deselect(),this.enemiesMenu.deselect(),this.currentMenu=null,this.battleScene.receivePlayerSelection("attack",e)}},{key:"createMenu",value:function(){this.remapHeroes(),this.remapEnemies(),this.battleScene.nextTurn()}},{key:"create",value:function(){this.graphics=this.add.graphics(),this.graphics.lineStyle(1,16777215),this.graphics.fillStyle(204620,1),this.graphics.strokeRect(2,400,220,200),this.graphics.fillRect(2,400,220,200),this.graphics.strokeRect(225,400,220,200),this.graphics.fillRect(225,400,220,200),this.graphics.strokeRect(448,400,350,200),this.graphics.fillRect(448,400,350,200),this.menus=this.add.container(),this.heroesMenu=new O(460,425,this),this.actionsMenu=new E(250,425,this),this.enemiesMenu=new B(8,425,this),this.currentMenu=this.actionsMenu,this.menus.add(this.heroesMenu),this.menus.add(this.actionsMenu),this.menus.add(this.enemiesMenu),this.battleScene=this.scene.get("BattleScene"),this.input.keyboard.on("keydown",this.onKeyInput,this),this.battleScene.events.on("PlayerSelect",this.onPlayerSelect,this),this.events.on("SelectAction",this.onSelectAction,this),this.events.on("Enemy",this.onEnemy,this),this.sys.events.on("wake",this.createMenu,this),this.message=new j(this,this.battleScene.events),this.add.existing(this.message),this.createMenu()}}]),n}(),x=function(e){d(n,Phaser.GameObjects.Sprite);var t=v(n);function n(e,i,s,r,a,o,h,c){var l;return m(this,n),(l=t.call(this,e,i,s,r,a)).type=o,l.maxHp=l.hp=h,l.damage=c,l.living=!0,l.menuItem=null,l}return f(n,[{key:"setMenuItem",value:function(e){this.menuItem=e}},{key:"attack",value:function(e){e.living&&(e.takeDamage(this.damage),this.scene.events.emit("Message",this.type+" attacks "+e.type+" for "+this.damage+" damage"))}},{key:"takeDamage",value:function(e){this.hp-=e,this.hp<=0&&(this.hp=0,this.menuItem.unitKilled(),this.living=!1,this.visible=!1,this.menuItem=null)}}]),n}(),S=function(e){d(n,e);var t=v(n);function n(e,i,s,r,a,o,h,c){var l;return m(this,n),(l=t.call(this,e,i,s,r,a,o,h,c)).setScale(2),l}return n}(x),M=function(e){d(n,e);var t=v(n);function n(e,i,s,r,a,o,h,c){var l;return m(this,n),(l=t.call(this,e,i,s,r,a,o,h,c)).flipX=!0,l.setScale(1.5),l}return n}(x),P=function(e){d(n,Phaser.GameObjects.Text);var t=v(n);function n(e,i,s,r){return m(this,n),t.call(this,r,e,i,s,{color:"#ffffff",align:"left",fontSize:15})}return f(n,[{key:"select",value:function(){this.setColor("#f8ff38")}},{key:"deselect",value:function(){this.setColor("#ffffff")}},{key:"unitKilled",value:function(){this.active=!1,this.visible=!1}}]),n}(),R=function(e){d(n,Phaser.GameObjects.Container);var t=v(n);function n(e,i,s,r){var a;return m(this,n),(a=t.call(this,s,e,i)).menuItems=[],a.menuItemIndex=0,a.heroes=r,a.x=e,a.y=i,a.selected=!1,a}return f(n,[{key:"addMenuItem",value:function(e){var t=new P(0,20*this.menuItems.length,e,this.scene);return this.menuItems.push(t),this.add(t),t}},{key:"moveSelectionUp",value:function(){this.menuItems[this.menuItemIndex].deselect();do{this.menuItemIndex--,this.menuItemIndex<0&&(this.menuItemIndex=this.menuItems.length-1)}while(!this.menuItems[this.menuItemIndex].active);this.menuItems[this.menuItemIndex].select()}},{key:"moveSelectionDown",value:function(){this.menuItems[this.menuItemIndex].deselect();do{this.menuItemIndex++,this.menuItemIndex>=this.menuItems.length&&(this.menuItemIndex=0)}while(!this.menuItems[this.menuItemIndex].active);this.menuItems[this.menuItemIndex].select()}},{key:"select",value:function(e){for(e||(e=0),this.menuItems[this.menuItemIndex].deselect(),this.menuItemIndex=e;!this.menuItems[this.menuItemIndex].active;)if(this.menuItemIndex++,this.menuItemIndex>=this.menuItems.length&&(this.menuItemIndex=0),this.menuItemIndex==e)return;this.menuItems[this.menuItemIndex].select(),this.selected=!0}},{key:"deselect",value:function(){this.menuItems[this.menuItemIndex].deselect(),this.menuItemIndex=0,this.selected=!1}},{key:"confirm",value:function(){}},{key:"clear",value:function(){for(var e=0;e<this.menuItems.length;e++)this.menuItems[e].destroy();this.menuItems.length=0,this.menuItemIndex=0}},{key:"remap",value:function(e){this.clear();for(var t=0;t<e.length;t++){var n=e[t];n.setMenuItem(this.addMenuItem(n.type))}this.menuItemIndex=0}}]),n}(),O=function(e){d(n,e);var t=v(n);function n(e,i,s){return m(this,n),t.call(this,e,i,s)}return n}(R),E=function(e){d(n,e);var t=v(n);function n(e,i,s){var r;return m(this,n),(r=t.call(this,e,i,s)).addMenuItem("Attack"),r}return f(n,[{key:"confirm",value:function(){this.scene.events.emit("SelectAction")}}]),n}(R),B=function(e){d(n,e);var t=v(n);function n(e,i,s){return m(this,n),t.call(this,e,i,s)}return f(n,[{key:"confirm",value:function(){this.scene.events.emit("Enemy",this.menuItemIndex)}}]),n}(R),j=function(e){d(n,Phaser.GameObjects.Container);var t=v(n);function n(e,i){var s;m(this,n);var r=(s=t.call(this,e,260,40)).scene.add.graphics();return s.add(r),r.lineStyle(1,16777215,.8),r.fillStyle(204620,.3),r.strokeRect(-145,-25,280,60),r.fillRect(-145,-25,280,60),s.text=new Phaser.GameObjects.Text(e,0,0,"",{color:"#ffffff",align:"center",fontSize:17,wordWrap:{width:260,useAdvancedWrap:!0}}),s.add(s.text),s.text.setOrigin(.5),i.on("Message",s.showMessage,g(s)),s.visible=!1,s}return f(n,[{key:"showMessage",value:function(e){this.text.setText(e),this.visible=!0,this.hideEvent&&this.hideEvent.remove(!1),this.hideEvent=this.scene.time.addEvent({delay:2e3,callback:this.hideMessage,callbackScope:this})}},{key:"hideMessage",value:function(){this.hideEvent=null,this.visible=!1}}]),n}(),T={type:Phaser.AUTO,width:800,height:600,pixelArt:!0,physics:{default:"arcade",arcade:{gravity:{y:0},debug:!0}},scene:[c,l,k,w]};new Phaser.Game(T)})();